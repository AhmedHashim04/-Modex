{% load static %}

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- HTMX -->
<script src="https://unpkg.com/htmx.org@1.9.12"></script>

<!-- Custom JS -->
<script src="{% static 'js/products.js' %}"></script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/cart.js' %}"></script>

<script>
    function updateModexTime() {
        const el = document.getElementById('modexCurrentTime');
        if (!el) return;
        const now = new Date();
        el.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    setInterval(updateModexTime, 1000);
    updateModexTime();
</script>

<script>
    // ✅ 1. دالة لجلب الـ CSRF Token من الكوكيز
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // ✅ 3. تنفيذ الطلب عند الضغط على أي زر من class="wishlist-btn"
    document.querySelectorAll('.wishlist-btn').forEach(btn => {

        btn.addEventListener('click', function () {
            const slug = this.dataset.slug;
            const icon = this.querySelector('i');

            fetch("{% url 'accounts:toggle_wishlist' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrftoken,
                },
                body: new URLSearchParams({ slug: slug })
            })

            .then(async response => {

                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    throw new Error("الرد من السيرفر غير صالح (ليس JSON)");
                }

                if (!response.ok) {
                    throw new Error(data.message || "حدث خطأ أثناء المعالجة.");
                }

                if (data.status === 'added') {
                    icon.classList.remove('far');
                    icon.classList.add('fas', 'text-danger');
                } else if (data.status === 'removed') {
                    icon.classList.remove('fas', 'text-danger');
                    icon.classList.add('far');
                }

            })

        });
    });

</script>
