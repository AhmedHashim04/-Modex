{% load i18n %}
{% if product.slug not in contextCart %}
    <form method="POST" action="{% url 'cart:cart_add' product.slug %}" class="d-flex align-items-center flex-nowrap w-100" id="add-to-cart-form-{{ product.slug }}">
        {% csrf_token %}
        <div class="quantity-control d-flex align-items-center flex-shrink-0" style="width: 90px; min-width: 90px;">
            <input type="number" name="quantity" class="quantity-input form-control form-control-sm mx-1 text-center" value="1" min="1" max="{{ product.stock }}" style="width: 90px;" required>
        </div>
        <button type="submit" class="action-btn cart-btn btn btn-primary btn-sm px-3 py-2 rounded-pill ms-3 flex-grow-1 d-flex align-items-center justify-content-center" style="min-width: 44px;">
            <i class="fas fa-shopping-cart me-2"></i>
            {% trans "Add" %}
        </button>
    </form>
{% else %}
    <form method="POST" action="{% url 'cart:cart_remove' product.slug %}" class="d-inline-block flex-grow-1" id="remove-from-cart-form-{{ product.slug }}">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center" style="min-width: 44px;">
            <i class="fas fa-trash-alt me-2"></i>{% trans "Remove" %}
        </button>
    </form>
{% endif %}

<script>
// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update cart counter
function updateCartIndicator(count) {
    const cartCounters = document.querySelectorAll('.cart-counter');
    cartCounters.forEach(counter => {
        const prevCount = parseInt(counter.textContent || 0);
        counter.textContent = count;
        if (count > prevCount) {
            animateCartIcon();
        }
    });
}

// Animate cart icon
function animateCartIcon() {
    const cartIcon = document.querySelector('#cart-link i.fa-shopping-cart');
    if (cartIcon) {
        cartIcon.classList.add('animate-bounce');
        setTimeout(() => {
            cartIcon.classList.remove('animate-bounce');
        }, 1000);
    }
}

// Translation strings for JS
const cartTranslations = {
    success: {
        add: "{% blocktrans %}Product added to cart successfully!{% endblocktrans %}",
        remove: "{% blocktrans %}Product removed from cart.{% endblocktrans %}"
    },
    error: {
        generic: "{% blocktrans %}An error occurred.{% endblocktrans %}",
        network: "{% blocktrans %}A network error occurred.{% endblocktrans %}"
    }
};

// Handle cart form submit
async function handleCartFormSubmit(form, actionType) {
    const formData = new FormData(form);
    const csrfToken = getCookie('csrftoken');
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        if (data.success) {
            // Update product UI
            const productContainer = form.closest('.product-container') || form.closest('.card');
            if (productContainer && data.updated_html) {
                productContainer.innerHTML = data.updated_html;
                initializeCartForms();
            }
            // Update cart counter
            if (data.cart_count !== undefined) {
                updateCartIndicator(data.cart_count);
            }
            // Show translated toast
            let msg = data.message;
            if (!msg) {
                msg = actionType === 'add' ? cartTranslations.success.add : cartTranslations.success.remove;
            }
            showToast(msg, 'success');
        } else {
            let msg = data.message || cartTranslations.error.generic;
            showToast(msg, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast(cartTranslations.error.network, 'error');
    }
}

// Show toast message
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} position-fixed bottom-0 end-0 m-3`;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Initialize forms on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeCartForms();
});

// Bind form events
function initializeCartForms() {
    document.querySelectorAll('[id^="add-to-cart-form-"], [id^="remove-from-cart-form-"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const actionType = this.id.startsWith('add') ? 'add' : 'remove';
            handleCartFormSubmit(this, actionType);
        });
    });
}
</script>

<style>
.animate-bounce {
    animation: bounce 0.5s;
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}
.toast {
    padding: 12px 16px;
    border-radius: 4px;
    color: white;
    z-index: 1000;
}
.toast-success {
    background-color: #28a745;
}
.toast-error {
    background-color: #dc3545;
}
</style>