{% if product.slug not in contextCart or not user.is_authenticated %}
    <form method="POST" action="{% url 'cart:cart_add' product.slug %}" class="d-flex align-items-center flex-nowrap w-100" id="add-to-cart-form-{{ product.slug }}">
        {% csrf_token %}
        <div class="quantity-control d-flex align-items-center flex-shrink-0" style="width: 90px; min-width: 90px;">
            <button class="quantity-btn minus btn btn-outline-secondary btn-sm px-2 py-1" type="button" tabindex="-1">-</button>
            <input type="number" name="quantity" class="quantity-input form-control form-control-sm mx-1 text-center" value="1" min="1" max="{{ product.stock }}" style="width: 90px;" required>
        </div>
        <button type="submit" class="action-btn cart-btn btn btn-primary btn-sm px-3 py-2 rounded-pill ms-3 flex-grow-1 d-flex align-items-center justify-content-center" style="min-width: 44px;">
            <i class="fas fa-shopping-cart me-2"></i>
        </button>
    </form>
{% else %}
    <form method="POST" action="{% url 'cart:cart_remove' product.slug %}" class="d-inline-block flex-grow-1" id="remove-from-cart-form-{{ product.slug }}">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center" style="min-width: 44px;">
            <i class="fas fa-trash-alt me-2"></i>Remove
        </button>
    </form>
{% endif %}

<script>
// الحصول على CSRF token من الكوكيز
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    initializeCartForms();
});

function initializeCartForms() {
    // معالجة إضافة المنتج إلى السلة
    document.querySelectorAll('[id^="add-to-cart-form-"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            handleCartFormSubmit(this, 'add');
        });
    });

    // معالجة إزالة المنتج من السلة
    document.querySelectorAll('[id^="remove-from-cart-form-"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            handleCartFormSubmit(this, 'remove');
        });
    });
}

function handleCartFormSubmit(form, actionType) {
    const formData = new FormData(form);
    const csrfToken = getCookie('csrftoken');
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        credentials: 'include' // مهم لإرسال الكوكيز
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // تحديث الواجهة
            const productContainer = form.closest('.product-container') || form.closest('.card');
            if (productContainer && data.updated_html) {
                productContainer.innerHTML = data.updated_html;
                initializeCartForms(); // إعادة ربط الأحداث للنماذج الجديدة
            }
            
            showToast(data.message, 'success');
            
            // تحديث عداد السلة إذا كان موجوداً
            if (data.cart_count !== undefined) {
                updateCartCount(data.cart_count);
            }
        } else {
            showToast(data.message || 'حدث خطأ ما', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('حدث خطأ في الاتصال بالخادم', 'error');
    });
}

function updateCartCount(count) {
    const cartCountElements = document.querySelectorAll('.cart-count');
    cartCountElements.forEach(el => {
        el.textContent = count;
    });
}

function showToast(message, type) {
    // يمكنك استخدام مكتبة مثل Toastify.js أو SweetAlert2 لعرض رسائل أجمل
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>